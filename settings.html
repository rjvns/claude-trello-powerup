<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Claude Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f5f7;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        h2 {
            color: #172b4d;
            margin-top: 0;
            font-size: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #5e6c84;
            font-size: 14px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #dfe1e6;
            border-radius: 3px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #0079bf;
        }
        button {
            background: #0079bf;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
            width: 100%;
        }
        button:hover {
            background: #005a8b;
        }
        .info {
            margin-top: 12px;
            padding: 12px;
            background: #f4f5f7;
            border-radius: 3px;
            font-size: 13px;
            color: #5e6c84;
        }
        .info a {
            color: #0079bf;
            text-decoration: none;
        }
        .info a:hover {
            text-decoration: underline;
        }
        .success {
            margin-top: 12px;
            padding: 12px;
            background: #d4f4dd;
            border-radius: 3px;
            color: #00875a;
            font-size: 14px;
            display: none;
        }
        .error {
            margin-top: 12px;
            padding: 12px;
            background: #ffebe6;
            border-radius: 3px;
            color: #c9372c;
            font-size: 14px;
            display: none;
        }
        .current-status {
            margin-top: 8px;
            padding: 8px;
            background: #fff;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            font-size: 13px;
            color: #5e6c84;
        }
    </style>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Claude Settings</h2>
        
        <label for="apiKey">Claude API Key:</label>
        <input 
            type="password" 
            id="apiKey" 
            placeholder="Enter your Claude API key"
            autocomplete="off"
        />
        
        <div class="current-status" id="status">
            Checking current status...
        </div>
        
        <div class="info">
            Get your API key from 
            <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
        </div>
        
        <button id="saveBtn">Save Settings</button>
        
        <div class="success" id="successMsg">
            ✓ Settings saved successfully!
        </div>
        
        <div class="error" id="errorMsg">
            Failed to save settings. Please try again.
        </div>
    </div>

    <script>
        const t = window.TrelloPowerUp.iframe();
        const apiKeyInput = document.getElementById('apiKey');
        const saveBtn = document.getElementById('saveBtn');
        const successMsg = document.getElementById('successMsg');
        const errorMsg = document.getElementById('errorMsg');
        const statusDiv = document.getElementById('status');
        
        // Load existing API key on page load
        async function loadSettings() {
            try {
                console.log('Loading existing settings...');
                const apiKey = await t.get('board', 'shared', 'claudeApiKey');
                
                if (apiKey) {
                    // Show masked version of the key
                    apiKeyInput.value = apiKey;
                    const maskedKey = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 4);
                    statusDiv.innerHTML = `✓ API key configured: <code>${maskedKey}</code>`;
                    statusDiv.style.color = '#00875a';
                } else {
                    statusDiv.innerHTML = '⚠️ No API key configured yet';
                    statusDiv.style.color = '#c9372c';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                statusDiv.innerHTML = '⚠️ Could not load current settings';
                statusDiv.style.color = '#c9372c';
            }
        }
        
        // Save settings
        async function saveSettings() {
            const apiKey = apiKeyInput.value.trim();
            
            // Hide any previous messages
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            if (!apiKey) {
                errorMsg.textContent = 'Please enter an API key';
                errorMsg.style.display = 'block';
                return;
            }
            
            // Basic validation - Claude API keys start with 'sk-ant-'
            if (!apiKey.startsWith('sk-ant-')) {
                errorMsg.textContent = 'Invalid API key format. Claude API keys start with "sk-ant-"';
                errorMsg.style.display = 'block';
                return;
            }
            
            try {
                console.log('Saving API key to board storage...');
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
                
                // Save to board-level shared storage
                await t.set('board', 'shared', 'claudeApiKey', apiKey);
                
                console.log('API key saved successfully');
                successMsg.style.display = 'block';
                
                // Update status
                const maskedKey = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 4);
                statusDiv.innerHTML = `✓ API key configured: <code>${maskedKey}</code>`;
                statusDiv.style.color = '#00875a';
                
                // Test the API key
                await testApiKey(apiKey);
                
                // Close the popup after a short delay
                setTimeout(() => {
                    t.closePopup();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving settings:', error);
                errorMsg.textContent = 'Failed to save settings: ' + error.message;
                errorMsg.style.display = 'block';
            } finally {
                saveBtn.textContent = 'Save Settings';
                saveBtn.disabled = false;
            }
        }
        
        // Test the API key with a simple request
        async function testApiKey(apiKey) {
            try {
                console.log('Testing API key...');
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 10,
                        messages: [{
                            role: 'user',
                            content: 'Hi'
                        }]
                    })
                });
                
                if (response.ok) {
                    console.log('API key is valid!');
                    successMsg.textContent = '✓ Settings saved and API key verified!';
                } else {
                    console.warn('API key might be invalid:', response.status);
                    successMsg.textContent = '✓ Settings saved (API key not verified)';
                }
            } catch (error) {
                console.error('Could not verify API key:', error);
                // Don't show error - key might still be valid
            }
        }
        
        // Event listeners
        saveBtn.addEventListener('click', saveSettings);
        
        // Allow Enter key to save
        apiKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveSettings();
            }
        });
        
        // Load settings when page loads
        loadSettings();
        
        // Resize the iframe to fit content
        t.sizeTo('#container');
    </script>
</body>
</html>
